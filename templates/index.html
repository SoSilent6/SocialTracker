<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Follower Count</title>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 2rem;
            color: #00ffcc;
        }
        
        .dataframe {
            margin: 20px auto;
            max-width: 1200px;  /* Fixed maximum width */
            table-layout: fixed;  /* Fixed table layout */
        }
        
        .dataframe th {
            padding: 8px 10px !important;
            text-align: right !important;
            color: #00ffcc;
            font-weight: normal;
            white-space: nowrap;
        }
        
        .dataframe td {
            padding: 8px 10px !important;
            text-align: right !important;
        }
        
        /* Token column (first column) */
        .dataframe td:first-child {
            text-align: left !important;
            white-space: nowrap;
            width: 200px;  /* Fixed width for first column */
        }
        
        /* Style for the token links */
        .token-link {
            color: #00ffcc;
            text-decoration: none;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 10px;
            white-space: nowrap;
        }
        
        .token-link:hover {
            background-color: rgba(0, 255, 204, 0.1);
        }
        
        /* Column widths */
        .dataframe th:nth-child(2),
        .dataframe td:nth-child(2) { 
            min-width: 120px !important; 
            width: 120px !important; 
        }
        
        .dataframe th:nth-child(3),
        .dataframe td:nth-child(3) { width: 100px; }  /* X粉丝数量 */
        
        .dataframe th:nth-child(4),
        .dataframe td:nth-child(4) { 
            min-width: 120px !important; 
            width: 120px !important; 
        }
        
        .dataframe th:nth-child(5),
        .dataframe td:nth-child(5) { width: 100px; }  /* 24h粉丝涨跌 (X) */
        
        .dataframe th:nth-child(6),
        .dataframe td:nth-child(6) { 
            min-width: 120px !important; 
            width: 120px !important; 
        }
        
        /* Alternating row colors */
        .dataframe tr:nth-child(even) {
            background-color: #1e1e1e;
        }
        
        .dataframe tr:nth-child(odd) {
            background-color: #141414;
        }
        
        /* Header break styling */
        .header-break {
            display: block;
            font-size: 0.8em;
            color: #888;
        }
        
        /* Sorting arrows styling */
        .sort-header {
            cursor: pointer;
        }
        
        .sort-header:hover {
            background-color: rgba(0, 255, 204, 0.1);
        }
        
        th {
            white-space: nowrap !important;  /* Prevent header text wrapping */
            padding: 12px !important;
            vertical-align: middle !important;
        }
        
        .sort-arrow {
            display: inline-block;
            margin-left: 8px;
            font-size: 16px;
            cursor: pointer;
            color: #00ffcc;
            background: transparent;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            padding: 2px 6px;
            vertical-align: middle;
        }
        
        .sort-arrow:hover {
            background-color: rgba(0, 255, 204, 0.1);
        }
        
        /* Ensure the token cell has enough width */
        td:first-child {
            min-width: 150px;
        }
        
        .customize-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            color: #00ffcc;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            padding: 12px 24px;  /* Bigger padding */
            cursor: pointer;
            z-index: 1000;
            font-size: 18px;    /* Bigger font */
        }
        
        .customize-button:hover {
            background-color: rgba(0, 255, 204, 0.1);
        }
        
        .column-selector {
            display: none;
            position: absolute;
            top: 70px;          /* Adjusted for bigger button */
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            padding: 20px;      /* More padding */
            z-index: 1000;
            min-width: 250px;   /* Ensure enough width */
        }
        
        .column-option {
            display: flex;
            align-items: center;
            margin: 15px 0;     /* More vertical spacing */
            color: white;
            font-size: 16px;    /* Bigger font */
        }
        
        .column-option input[type="checkbox"] {
            width: 20px;        /* Bigger checkbox */
            height: 20px;       /* Bigger checkbox */
            margin-right: 15px; /* More spacing after checkbox */
            cursor: pointer;
        }
        
        .column-option label {
            cursor: pointer;    /* Make labels clickable */
            user-select: none;  /* Prevent text selection */
            flex: 1;           /* Take remaining space */
            padding: 5px 0;    /* Bigger click target */
        }
        
        /* Make the entire option row clickable */
        .column-option:hover {
            background-color: rgba(0, 255, 204, 0.1);
            border-radius: 4px;
            padding-left: 10px;
            margin-left: -10px;
            margin-right: -10px;
            padding-right: 10px;
        }
        
        .hidden-column {
            display: none;
        }
        
        .last-update {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ffcc;
            font-size: 16px;
            padding: 12px 24px;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            background: transparent;
        }
        
        .column-toggles {
            padding: 20px;
            background: #111;
            border-radius: 10px;
            border: 1px solid #00ffcc;
        }

        .toggle-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            background: #222;
            border: 1px solid #00ffcc;
            border-radius: 6px;
            color: #00ffcc;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-button.active {
            background: #00ffcc22;
        }

        .toggle-button:hover {
            background: #00ffcc11;
        }

        /* Custom checkbox styling */
        .toggle-button .checkbox-icon {
            float: right;
            width: 20px;
            height: 20px;
            border: 2px solid #00ffcc;
            border-radius: 4px;
            margin-left: 10px;
            position: relative;
        }

        .toggle-button.active .checkbox-icon:after {
            content: '✓';
            position: absolute;
            color: #00ffcc;
            font-size: 16px;
            top: -2px;
            left: 2px;
        }
    </style>
</head>
<body>
    <h1>Crypto社交平台数据</h1>
    <div style="text-align: center; margin: 20px;">
        <input type="text" id="tokenSearch" placeholder="搜索代币..." 
               style="background: black; color: white; border: 1px solid #00ffcc; padding: 8px; border-radius: 4px;">
    </div>
    
    <div>
        {{ data | safe }}
    </div>
    
    <button class="customize-button" onclick="toggleColumnSelector()">自定义</button>
    <div class="column-selector" id="columnSelector">
        <div class="column-toggles">
            <button class="toggle-button active" data-column="x_followers">
                X粉丝数量
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button active" data-column="x_24h">
                24h粉丝涨跌(X)
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button" data-column="x_3d">
                3天粉丝涨跌(X)
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button active" data-column="discord_followers">
                Discord粉丝数量
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button active" data-column="discord_24h">
                24h粉丝涨跌(Discord)
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button" data-column="discord_3d">
                3天粉丝涨跌(Discord)
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button active" data-column="telegram_followers">
                Telegram粉丝数量
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button active" data-column="telegram_24h">
                24h粉丝涨跌(Telegram)
                <span class="checkbox-icon"></span>
            </button>
            <button class="toggle-button" data-column="telegram_3d">
                3天粉丝涨跌(Telegram)
                <span class="checkbox-icon"></span>
            </button>
        </div>
    </div>
    
    <div class="last-update">最后更新：{{ last_update }}</div>
    
    <script>
        const columns = {
            'token': '代币',
            'x_followers': 'X粉丝数量',
            'x_24h': '24h粉丝涨跌(X)',
            'x_3d': '3天粉丝涨跌(X)',
            'discord_followers': 'Discord粉丝数量',
            'discord_24h': '24h粉丝涨跌(Discord)',
            'discord_3d': '3天粉丝涨跌(Discord)',
            'telegram_followers': 'Telegram粉丝数量',
            'telegram_24h': '24h粉丝涨跌(Telegram)',
            'telegram_3d': '3天粉丝涨跌(Telegram)'
        };

        // Default hidden columns
        const defaultHiddenColumns = [
            '3天粉丝涨跌(X)',
            '3天粉丝涨跌(Discord)',
            '3天粉丝涨跌(Telegram)'
        ];

        // Initialize column visibility
        let columnVisibility = {};
        for (let key in columns) {
            columnVisibility[columns[key]] = !defaultHiddenColumns.includes(columns[key]);
        }

        function updateColumnVisibility() {
            const table = document.querySelector('table.dataframe');
            if (!table) return;

            const headerRow = table.querySelector('thead tr');
            if (!headerRow) return;

            const headers = headerRow.querySelectorAll('th');
            
            headers.forEach((header, index) => {
                const headerText = header.textContent.trim();
                const isVisible = columnVisibility[headerText] !== false;  // Default to visible if not set
                
                // Update header visibility
                header.style.display = isVisible ? '' : 'none';
                
                // Update all cells in this column
                table.querySelectorAll('tbody tr').forEach(row => {
                    const cell = row.cells[index];
                    if (cell) {
                        cell.style.display = isVisible ? '' : 'none';
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.toggle-button');
            
            buttons.forEach(button => {
                const columnKey = button.dataset.column;
                const columnName = columns[columnKey];
                
                // Set initial state
                button.classList.toggle('active', !defaultHiddenColumns.includes(columnName));
                
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                    columnVisibility[columnName] = button.classList.contains('active');
                    updateColumnVisibility();
                });
            });
            
            // Initial visibility update
            updateColumnVisibility();
        });

        const table = document.querySelector('.dataframe');
        const tbody = table.querySelector('tbody');
        const originalOrder = Array.from(tbody.querySelectorAll('tr')).map(row => row.cloneNode(true));
        
        // Add click handlers to headers
        table.querySelectorAll('th').forEach((header, index) => {
            if (header.textContent.includes('↕')) {
                header.onclick = () => sortTableWithReset(index);
            }
        });
        
        let sortStates = {};
        
        function sortTableWithReset(columnIndex) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            sortStates[columnIndex] = (sortStates[columnIndex] || 0) + 1;
            if (sortStates[columnIndex] > 2) sortStates[columnIndex] = 0;
            
            // Clear tbody
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            if (sortStates[columnIndex] === 0) {
                // Reset to original order
                originalOrder.forEach(row => tbody.appendChild(row.cloneNode(true)));
            } else {
                // Sort
                rows.sort((a, b) => compareValues(a, b, columnIndex, sortStates[columnIndex] === 1));
                rows.forEach(row => tbody.appendChild(row));
            }
        }
        
        function compareValues(a, b, columnIndex, ascending) {
            let aVal = a.cells[columnIndex].textContent.trim().replace('%', '');
            let bVal = b.cells[columnIndex].textContent.trim().replace('%', '');
            
            aVal = aVal === '' ? 0 : parseFloat(aVal);
            bVal = bVal === '' ? 0 : parseFloat(bVal);
            
            return ascending ? aVal - bVal : bVal - aVal;
        }

        document.getElementById('tokenSearch').addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            const rows = document.querySelectorAll('.dataframe tr');
            
            rows.forEach((row, index) => {
                if (index === 0) return; // Skip header row
                const tokenCell = row.cells[0];
                if (tokenCell) {
                    const token = tokenCell.textContent.toLowerCase();
                    row.style.display = token.includes(searchText) ? '' : 'none';
                }
            });
        });

        // Debug: Log the headers to verify they're being found
        console.log("Sort headers found:", document.querySelectorAll('.sort-header').length);

        function toggleColumnSelector() {
            const selector = document.getElementById('columnSelector');
            selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
        }
        
        // Close the selector if clicking outside
        document.addEventListener('click', function(event) {
            const selector = document.getElementById('columnSelector');
            const customizeButton = document.querySelector('.customize-button');
            if (!selector.contains(event.target) && event.target !== customizeButton) {
                selector.style.display = 'none';
            }
        });
        
        function toggleColumn(columnIndex, show) {
            const table = document.querySelector('.dataframe');
            const headers = table.querySelectorAll('th');
            const rows = table.querySelectorAll('tr');
            
            // Toggle header
            if (headers[columnIndex]) {
                headers[columnIndex].classList.toggle('hidden-column', !show);
            }
            
            // Toggle cells
            rows.forEach(row => {
                const cell = row.cells[columnIndex];
                if (cell) {
                    cell.classList.toggle('hidden-column', !show);
                }
            });
        }
    </script>
</body>
</html>